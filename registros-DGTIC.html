<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario Zoom desde Excel</title>

  <!-- Bootstrap y DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
    .table td, .table th { vertical-align: middle; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .card-header i { font-size: 1.2rem; }
    @media (max-width: 576px) {
      .navbar-brand { font-size: 1.1rem; }
      .card { border: none !important; box-shadow: none !important; padding: 1rem !important; }
    }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-laptop-fill me-2"></i>Mi Formulario</a>
  </div>
</nav>

<div class="container py-4">
  <h3 class="text-secondary mb-4"><i class="bi bi-journal-bookmark-fill me-2"></i>Formulario Zoom desde Excel</h3>

  <!-- Card de carga de archivo -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <i class="bi bi-upload me-2"></i> Cargar archivo Excel
    </div>
    <div class="card-body">
      <label for="fileInput" class="form-label fw-bold">Selecciona el archivo Excel (.xlsx)</label>
      <div class="input-group mb-2">
        <span class="input-group-text"><i class="bi bi-file-earmark-excel-fill text-success"></i></span>
        <input type="file" id="fileInput" accept=".xlsx" class="form-control">
      </div>
      <small class="text-muted">Tamaño máximo: 300MB</small>
    </div>
  </div>

  <!-- Card de tabla de datos -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="tabla" class="table table-bordered table-striped table-hover align-middle">
          <thead><tr id="encabezado"></tr></thead>
          <tbody id="contenido"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para script -->
<div class="modal fade" id="modalScript" tabindex="-1" aria-labelledby="modalScriptLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title"><i class="bi bi-code-slash me-2"></i>Script para consola</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ol class="mb-3">
          <li>Abre la pestaña de Zoom que se abrió</li>
          <li>Presiona <kbd>F12</kbd> y selecciona la pestaña <strong>Console</strong></li>
          <li>Pega el siguiente código:</li>
        </ol>
        <pre id="codigoJS" class="bg-light p-3 rounded border"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-light" onclick="copiarAlPortapapeles()"><i class="bi bi-clipboard me-1"></i>Copiar</button>
        <button class="btn btn-primary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('fileInput').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    // Validación de tamaño máximo: 300MB
    if (file.size > 300 * 1024 * 1024) {
      alert('El archivo excede el tamaño máximo de 300MB. Por favor selecciona uno más pequeño.');
      event.target.value = ''; // limpia la selección
      return;
    }
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const datos = XLSX.utils.sheet_to_json(sheet);
    mostrarTabla(datos);
  });

  function mostrarTabla(datos) {
    const headers = Object.keys(datos[0]);
    const encabezadoRow = document.getElementById('encabezado');
    encabezadoRow.innerHTML = '';
    headers.forEach(campo => {
      const th = document.createElement('th');
      th.textContent = campo;
      encabezadoRow.appendChild(th);
    });
    encabezadoRow.innerHTML += '<th>Abrir</th><th>Script</th><th>Status</th>';

    const tbody = document.getElementById('contenido');
    tbody.innerHTML = '';
    datos.forEach(persona => {
      const fila = document.createElement('tr');
      headers.forEach(key => {
        const td = document.createElement('td');
        td.textContent = persona[key];
        fila.appendChild(td);
      });

      const tdAbrir = document.createElement('td');
      const btnAbrir = document.createElement('button');
      btnAbrir.className = 'btn btn-sm btn-success';
      btnAbrir.innerHTML = '<i class="bi bi-box-arrow-up-right me-1"></i>Abrir';
      btnAbrir.onclick = () => abrirFormularioZoom(persona);
      tdAbrir.appendChild(btnAbrir);
      fila.appendChild(tdAbrir);

      const tdScript = document.createElement('td');
      const btnScript = document.createElement('button');
      btnScript.className = 'btn btn-sm btn-outline-secondary';
      btnScript.innerHTML = '<i class="bi bi-terminal-fill me-1"></i>Script';
      btnScript.onclick = () => mostrarModal(generarScript(persona));
      tdScript.appendChild(btnScript);
      fila.appendChild(tdScript);

      const tdStatus = document.createElement('td');
      tdStatus.id = `status_${persona.Folio}`;
      fila.appendChild(tdStatus);

      tbody.appendChild(fila);
    });

    setTimeout(() => {
      if ($.fn.DataTable.isDataTable('#tabla')) {
        $('#tabla').DataTable().destroy();
      }
      $('#tabla').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
      });
    }, 100);
  }

  function abrirFormularioZoom(persona) {
    const url = persona.www || persona.URL || persona.url;
    if (!url) { alert('No se encontró una columna válida con URL.'); return; }
    const script = generarScript(persona);
    navigator.clipboard.writeText(script);
    window.open(url, '_blank');
    mostrarModal(script);
    const statusCell = document.getElementById(`status_${persona.Folio}`);
    if (statusCell) {
      statusCell.textContent = 'Seleccionado';
      statusCell.classList.add('bg-success-subtle', 'text-success');
    }
  }

  function generarScript(persona) {
    return `document.querySelector('#question_Folio').value = '${persona.Folio}';\n` +
           `document.querySelector('#question_first_name').value = '${persona.Folio}';\n` +
           `document.querySelector('#question_last_name').value = '${persona.Apellido || '-'}';\n` +
           `document.querySelector('#question_email').value = '${persona.Correo}';`;
  }

  function mostrarModal(script) {
    document.getElementById('codigoJS').textContent = script.trim();
    new bootstrap.Modal(document.getElementById('modalScript')).show();
  }

  function copiarAlPortapapeles() {
    const texto = document.getElementById('codigoJS').textContent;
    navigator.clipboard.writeText(texto).then(() => {
      alert('Código copiado al portapapeles.');
    });
  }
</script>
</body>
</html>
