<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario Zoom desde Excel</title>

  <!-- Bootstrap y DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
    .table td, .table th { vertical-align: middle; }
    .card-header i { font-size: 1.2rem; }
    @media (max-width: 576px) {
      .navbar-brand { font-size: 1.1rem; }
      .card { border: none !important; box-shadow: none !important; padding: 1rem !important; }
    }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-laptop-fill me-2"></i>Mi Formulario</a>
  </div>
</nav>

<div class="container py-4">
  <h3 class="text-secondary mb-4"><i class="bi bi-journal-bookmark-fill me-2"></i>Formulario Zoom desde Excel</h3>

  <!-- Card de carga de archivo -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <i class="bi bi-upload me-2"></i> Cargar archivo Excel
    </div>
    <div class="card-body">
      <label for="fileInput" class="form-label fw-bold">Selecciona el archivo Excel (.xlsx)</label>
      <div class="input-group mb-2">
        <span class="input-group-text"><i class="bi bi-file-earmark-excel-fill text-success"></i></span>
        <input type="file" id="fileInput" accept=".xlsx" class="form-control">
      </div>
      <small class="text-muted">Tamaño máximo: 300MB</small>
    </div>
  </div>

  <!-- Botón de descarga -->
  <button id="btnDescargar" class="btn btn-outline-success mb-3">
    <i class="bi bi-download me-1"></i>Descargar Registros
  </button>

  <!-- Card de tabla de datos -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="tabla" class="table table-bordered table-striped table-hover align-middle">
          <thead><tr id="encabezado"></tr></thead>
          <tbody id="contenido"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let registros = [];

  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0]; if (!file) return;
    if (file.size > 300 * 1024 * 1024) {
      alert('El archivo excede el tamaño máximo de 300MB.'); e.target.value = ''; return;
    }
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
    // Asegurar columna Status
    data.forEach(r => { if (!('Status' in r)) r.Status = ''; });
    registros = data;
    renderTable();
  });

  document.getElementById('btnDescargar').addEventListener('click', () => {
    const wb = XLSX.utils.table_to_book(document.getElementById('tabla'), { sheet: 'Registro' });
    XLSX.writeFile(wb, 'registro_zoom.xlsx');
  });

  function renderTable() {
    const hdrs = Object.keys(registros[0]);
    const hrow = document.getElementById('encabezado'); hrow.innerHTML = '';
    hdrs.forEach(h => { const th = document.createElement('th'); th.textContent = h; hrow.appendChild(th); });
    hrow.innerHTML += '<th>Abrir</th><th>Script</th>';

    const tb = document.getElementById('contenido'); tb.innerHTML = '';
    registros.forEach((p, i) => {
      const tr = document.createElement('tr');
      hdrs.forEach(h => {
        const td = document.createElement('td'); td.textContent = p[h];
        if (h === 'Status') td.id = `status_${i}`;
        tr.appendChild(td);
      });
      // Botón Abrir
      const tdA = document.createElement('td');
      tdA.innerHTML = `<button class="btn btn-sm btn-success"><i class="bi bi-box-arrow-up-right me-1"></i>Abrir</button>`;
      tdA.firstChild.onclick = () => abrirYActualizar(p, i);
      tr.appendChild(tdA);
      // Botón Script
      const tdS = document.createElement('td');
      tdS.innerHTML = `<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-terminal-fill me-1"></i>Script</button>`;
      tdS.firstChild.onclick = () => mostrarModal(generarScript(p));
      tr.appendChild(tdS);

      tb.appendChild(tr);
    });
    setTimeout(() => {
      if ($.fn.DataTable.isDataTable('#tabla')) $('#tabla').DataTable().destroy();
      $('#tabla').DataTable({ language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' } });
    }, 100);
  }

  function abrirYActualizar(persona, idx) {
    const url = persona.www || persona.URL || persona.url;
    if (!url) return alert('No se encontró URL válida.');
    const script = generarScript(persona);
    navigator.clipboard.writeText(script);
    window.open(url, '_blank');
    registros[idx].Status = 'Enviado';
    const cell = document.getElementById(`status_${idx}`);
    if (cell) { cell.textContent = 'Enviado'; cell.classList.add('bg-success-subtle','text-success'); }
  }

  function generarScript(persona) {
    return `(() => {
  const setAndFire = (sel, v) => {
    const e = document.querySelector(sel);
    e.value = v;
    e.dispatchEvent(new Event('input',{ bubbles:true }));
    e.dispatchEvent(new Event('change',{ bubbles:true }));
  };
  setAndFire('#question_Folio',      '${persona.Folio}');
  setAndFire('#question_first_name', '${persona.Folio}');
  setAndFire('#question_last_name',  '${persona.Apellido||'-'}');
  setAndFire('#question_email',      '${persona.Correo}');
})();`;
  }

  function mostrarModal(script) {
    let m = document.getElementById('modalScript');
    if (!m) {
      document.body.insertAdjacentHTML('beforeend',
`<div class="modal fade" id="modalScript" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title"><i class="bi bi-code-slash me-2"></i>Script para consola</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ol><li>Abre Zoom</li><li>F12 → Console</li><li>Pega el script</li></ol>
        <pre id="codigoJS" class="bg-light p-3 rounded border"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-light" onclick="copiarAlPortapapeles()"><i class="bi bi-clipboard me-1"></i>Copiar</button>
        <button class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>`);
      m = document.getElementById('modalScript');
    }
    document.getElementById('codigoJS').textContent = script;
    new bootstrap.Modal(m).show();
  }

  function copiarAlPortapapeles() {
    const t = document.getElementById('codigoJS').textContent;
    navigator.clipboard.writeText(t).then(() => alert('Código copiado al portapapeles.'));
  }
</script>
</body>
</html>
