<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario Zoom con Estado</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    .visitado {
      color: blue;
      text-decoration: underline;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body class="p-4">
  <h3 class="mb-4">Gestión de Registros de Zoom</h3>
  <div class="table-responsive">
    <table id="tabla" class="table table-bordered table-striped">
      <thead>
        <tr id="encabezado"></tr>
      </thead>
      <tbody id="contenido"></tbody>
    </table>
  </div>

  <!-- Modal para mostrar el JS -->
  <div class="modal fade" id="modalScript" tabindex="-1" aria-labelledby="modalScriptLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalScriptLabel">Instrucciones para llenar el formulario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Pasos:</strong></p>
          <ol>
            <li>Ve a la pestaña recién abierta del formulario de Zoom.</li>
            <li>Presiona <kbd>F12</kbd> o clic derecho → <strong>Inspeccionar</strong>.</li>
            <li>Abre la pestaña <strong>Console</strong>.</li>
            <li>Pega el siguiente código y presiona <kbd>Enter</kbd>:</li>
          </ol>
          <pre id="codigoJS" class="bg-light p-2 border rounded"></pre>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="copiarAlPortapapeles()">Copiar código</button>
          <button class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS + DataTables -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      cargarDatosDesdeExcel();
    });

    async function cargarDatosDesdeExcel() {
      const response = await fetch('datos_zoom.xlsx');
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const datos = XLSX.utils.sheet_to_json(sheet);

      const headers = Object.keys(datos[0]).map(h => h.trim());
      const encabezadoRow = document.getElementById('encabezado');
      headers.forEach(campo => {
        const th = document.createElement('th');
        th.textContent = campo.charAt(0).toUpperCase() + campo.slice(1);
        encabezadoRow.appendChild(th);
      });

      encabezadoRow.innerHTML += '<th>Evento</th><th>Estado</th>';

      const tbody = document.getElementById('contenido');
      tbody.innerHTML = '';

      datos.forEach(persona => {
        const fila = document.createElement('tr');
        headers.forEach(key => {
          const celda = document.createElement('td');
          if (key.toLowerCase() === 'url') {
            const urlTexto = document.createElement('span');
            urlTexto.textContent = persona[key];
            urlTexto.className = estadoVisitado(persona[key]) ? 'visitado' : '';
            urlTexto.id = `url_${persona.Folio}`;
            celda.appendChild(urlTexto);
          } else {
            celda.textContent = persona[key];
          }
          fila.appendChild(celda);
        });

        // Botón Evento
        const btnCell = document.createElement('td');
        const boton = document.createElement('button');
        boton.className = 'btn btn-sm btn-primary';
        boton.textContent = 'Evento';
        boton.onclick = () => abrirYllenarFormulario(persona);
        btnCell.appendChild(boton);
        fila.appendChild(btnCell);

        // Estado
        const estadoCell = document.createElement('td');
        estadoCell.textContent = estadoVisitado(persona.URL) ? 'Visitado' : 'Pendiente';
        estadoCell.id = `estado_${persona.Folio}`;
        if (estadoVisitado(persona.URL)) {
          estadoCell.classList.add('bg-success-subtle');
        }
        fila.appendChild(estadoCell);

        tbody.appendChild(fila);
      });

      // Inicializar DataTable una vez cargados los datos
      $('#tabla').DataTable({
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        }
      });
    }

    function estadoVisitado(url) {
      return localStorage.getItem('visitado_' + url) === 'true';
    }

    async function abrirYllenarFormulario(persona) {
      const scriptManual = `
document.querySelector('#question_Folio').value = '${persona.Folio}';
document.querySelector('#question_first_name').value = '${persona.Folio}';
document.querySelector('#question_last_name').value = '${persona.Apellido || '-'}';
document.querySelector('#question_email').value = '${persona.Correo}';`;

      try {
        const win = window.open(persona.URL, '_blank');

        const interval = setInterval(() => {
          try {
            win.eval(scriptManual);
            clearInterval(interval);
          } catch (error) {
            clearInterval(interval);
            mostrarModal(scriptManual);
          }
        }, 500);

        // Marcar como visitado
        localStorage.setItem('visitado_' + persona.URL, 'true');
        document.getElementById(`estado_${persona.Folio}`).textContent = 'Visitado';
        document.getElementById(`estado_${persona.Folio}`).classList.add('bg-success-subtle');
        document.getElementById(`url_${persona.Folio}`).classList.add('visitado');

      } catch (err) {
        console.error('Error al abrir y llenar:', err);
      }
    }

    function mostrarModal(script) {
      document.getElementById('codigoJS').textContent = script.trim();
      const modal = new bootstrap.Modal(document.getElementById('modalScript'));
      modal.show();
    }

    function copiarAlPortapapeles() {
      const texto = document.getElementById('codigoJS').textContent;
      navigator.clipboard.writeText(texto).then(() => {
        alert('Código copiado al portapapeles. Ve a la pestaña del formulario y pégalo en la consola.');
      });
    }
  </script>
</body>
</html>